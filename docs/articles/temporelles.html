<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Séries temporelles • ofce</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Fira_Code-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="temporelles_files/libs/quarto-html/popper.min.js"></script><script src="temporelles_files/libs/quarto-html/tippy.umd.min.js"></script><link href="temporelles_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="temporelles_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Séries temporelles">
<meta property="og:image" content="https://ofce.github.io/ofce/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ofce</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.27</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-manuels" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Manuels</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-manuels">
<li><a class="dropdown-item" href="../articles/site.html">Sites dédiés</a></li>
    <li><a class="dropdown-item" href="../articles/blog.html">Le Blog</a></li>
    <li><a class="dropdown-item" href="../articles/quarto.html">Ecrire un texte en quarto</a></li>
    <li><a class="dropdown-item" href="../articles/graphiques.html">Faire un graphique</a></li>
    <li><a class="dropdown-item" href="../articles/tableaux.html">Faire un tableau</a></li>
    <li><a class="dropdown-item" href="../articles/outils.html">Les outils</a></li>
    <li><a class="dropdown-item" href="../articles/semio.html">Le language des graphiques</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutoriaux" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutoriaux</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutoriaux">
<li><a class="dropdown-item" href="../articles/charte_graphique.html">Charte Graphique</a></li>
    <li><a class="dropdown-item" href="../articles/prevision.html">Charte Graphique pour la Prévision</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/temporelles.html">Séries temporelles</a></li>
    <li><a class="dropdown-item" href="../articles/xy.html">Graphiques XY</a></li>
    <li><a class="dropdown-item" href="../articles/categories.html">Barres empilées, wafle, treemap, lollypop</a></li>
    <li><a class="dropdown-item" href="../articles/distributions.html">Distributions</a></li>
    <li><a class="dropdown-item" href="../articles/cartes.html">Cartes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/source_data.html">Caché et robuste</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/qa.html">Quand ça ne marche pas</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ofce/ofce"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Séries temporelles</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <section class="level2"><h2 id="règles-dor">5 Règles d’or<a class="anchor" aria-label="anchor" href="#r%C3%A8gles-dor"></a>
</h2>
<blockquote>
<p><strong>Règle 1</strong> : On utilise <code><a href="../reference/theme_ofce.html">theme_ofce()</a></code> pour les graphiques !</p>
</blockquote>
<blockquote>
<p><strong>Règle 2</strong> : Les dates sont au format <code>&lt;date&gt;</code> même lorsque la fréquence est annuelle.</p>
</blockquote>
<blockquote>
<p><strong>Règle 3</strong> : On utilise <code>scale_x_date(date_breaks = "5 years", date_minor_breaks = "1 year", guide = "minor_ticks")</code> en définissant <code>date_breaks</code> à la fréquence souhaitée (en évitant trop de dates) et <code>date_minor_breaks</code> à une année (<code>"1 year"</code>).</p>
</blockquote>
<blockquote>
<p><strong>Règle 4</strong> : Si les <em>y</em> sont en %, alors mettre “%” dans le format de l’axe des <em>y</em>.</p>
</blockquote>
<blockquote>
<p><strong>Règle 5</strong> : On choisit un <code>line_width</code> entre 0.5 et 1 pour le <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code>, on ajoute un <code>geom_point(shape=21, stroke=0.25, col="white")</code> pour marquer les points auxquels on a des données. Si on peut mettre la légende sous forme de <em>labels</em>, c’est mieux car cela allège le graphique.</p>
</blockquote>
</section><section class="level2"><h2 id="les-données">Les données<a class="anchor" aria-label="anchor" href="#les-donn%C3%A9es"></a>
</h2>
<p>Pour les séries temporelles, il y a deux recommandations pour les données :</p>
<ol type="1">
<li><p>utilisez le format long pour les données du graphique. Il peut être plus simple pour calculer des taux de croissance ou des ratios de passer en format large, mais c’est mieux de passer en format long pour la partie graphique, avec une ou plusieurs colonnes pour différencier les lignes. Cela permettra d’associer une couleur à chaque série et une facette à chaque pays par exemple.</p></li>
<li><p>le champ décrivant les dates doit être en type <code>date</code>. ce n’est pas toujours évident quand les séries sont à fréquence annuelle, mais c’est très utile pour mélanger des séries de fréquence irrégulière, pour homogénéiser l’aspect des axes de dates et mieux maîtriser le formatage des dates. Pour convertir une date en date, soit elle est au format <code>&lt;character&gt;</code> sous la forme <code>"2022-12-01"</code> et la fonction <code><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">base::as.Date()</a></code> fonctionne très bien. Sinon, pour les autres cas, le package <a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a> (formation R niv. 1) est très pratique et propose de nombreuses fonctions permettant d’absorber beaucoup de cas (les fonctions sont par exemple <code><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">lubridate::ymd()</a></code> <code><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">lubridate::dmy()</a></code> <code><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">lubridate::my()</a></code> etc…).</p></li>
</ol>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2023</span>, <span class="fl">2024</span>, <span class="fl">2025</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span>, format  <span class="op">=</span> <span class="st">"%Y"</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "2023-12-03" "2024-12-03" "2025-12-03"</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># si on veut préciser le jour et le mois de l'année</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">dates</span>, <span class="st">"-01-01"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "2023-01-01" "2024-01-01" "2025-01-01"</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1/2023"</span>, <span class="st">"2/2024"</span>, <span class="st">"3/2025"</span><span class="op">)</span></span>
<span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html" class="external-link">my</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>[1] "2023-01-01" "2024-02-01" "2025-03-01"</code></pre>
</div>
</div>
<div>
<blockquote>
<p><strong>Note</strong></p>
<p>Dans le cas où les données proviennent d’Excel et sont en format numérique on peut utiliser <code>as.Date(df$date, origin = "1899-12-30")</code> pour les convertir en <code>&lt;date&gt;</code>.</p>
</blockquote>
</div>
<p>Prenons l’exemple du graphiques sur les spreads (<a href="https://www.ofce-legislatives2024.fr/analyses/spreads.html#fig-spread" class="external-link">legislatives2024, Blot Geerolf Plane</a>). Les données sont générées par un scrapping sur <em>investing.com</em> (en attendant une solution API sur une banque de données bien faite). Les données se présentent sous la forme.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spreads</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,117 × 3
   date       pays        taux
   &lt;date&gt;     &lt;chr&gt;      &lt;dbl&gt;
 1 2007-01-02 spreadfra 0.0130
 2 2007-01-03 spreadfra 0.0360
 3 2007-01-04 spreadfra 0.0280
 4 2007-01-05 spreadfra 0.0190
 5 2007-01-08 spreadfra 0.0440
 6 2007-01-09 spreadfra 0.0430
 7 2007-01-10 spreadfra 0.0290
 8 2007-01-11 spreadfra 0.0370
 9 2007-01-12 spreadfra 0.0340
10 2007-01-15 spreadfra 0.0380
# ℹ 10,107 more rows</code></pre>
</div>
</div>
<p>Les données sont au format long (avec deux modalités pour <code>pays</code> et donc 3 colonnes), les dates sont au format <code>&lt;date&gt;</code>, donc tout va presque bien. La colonne <code>pays</code> est un peu brute. On la transforme pour avoir un label plus propre et en facteur, pour contrôler l’ordre (on met France en premier, Italie en second). Il y a plusieurs méthodes pour arriver à ce résultat. Ici, on reste très simple parce qu’il n’y a que deux modalités. Si il y en avait plus de deux (et surtout un grand nombre, possiblement évolutif), on aurait fait quelques manipulations de chaînes et on aurait utilisé le package <a href="https://vincentarelbundock.github.io/countrycode/" class="external-link">countrycode</a> pour transformer les code pays en texte lisible, possiblement traduit dans différentes langues.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spreads_data</span> <span class="op">&lt;-</span> <span class="va">spreads</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html" class="external-link">distinct</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">pays</span>, .keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>pays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span> <span class="va">pays</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spreadfra"</span>, <span class="st">"spreadita"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"France"</span>, <span class="st">"Italie"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spreads</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10,117 × 3
   date       pays        taux
   &lt;date&gt;     &lt;chr&gt;      &lt;dbl&gt;
 1 2007-01-02 spreadfra 0.0130
 2 2007-01-03 spreadfra 0.0360
 3 2007-01-04 spreadfra 0.0280
 4 2007-01-05 spreadfra 0.0190
 5 2007-01-08 spreadfra 0.0440
 6 2007-01-09 spreadfra 0.0430
 7 2007-01-10 spreadfra 0.0290
 8 2007-01-11 spreadfra 0.0370
 9 2007-01-12 spreadfra 0.0340
10 2007-01-15 spreadfra 0.0380
# ℹ 10,107 more rows</code></pre>
</div>
</div>
</section><section class="level2"><h2 id="la-base-du-graphique">La base du graphique<a class="anchor" aria-label="anchor" href="#la-base-du-graphique"></a>
</h2>
<p>Le graphique de base est alors simple à construire. On utilise une couche <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code> et <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>, une couche <code><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes()</a></code> avec comme <code>x</code> les dates, <code>y</code> les taux et couleurs les pays. Pour <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code>, il faut préciser le groupe (cela peut paraître redondant, mais cela peut servir si on veut colorer en fonction d’une autre variable). L’ordre est important et le <code><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line()</a></code> est en premier et donc en dessous du <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ofce.github.io/ofce">ofce</a></span><span class="op">)</span></span>
<span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="fu">PrettyCols</span><span class="fu">::</span><span class="fu"><a href="https://nrennie.github.io/PrettyCols/reference/prettycols.html" class="external-link">prettycols</a></span><span class="op">(</span><span class="st">"Summer"</span>, n<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">date_maj</span> <span class="op">&lt;-</span> <span class="st">"2024-07-01"</span></span>
<span><span class="va">main</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spreads_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">taux</span>, fill <span class="op">=</span> <span class="va">pays</span>, color<span class="op">=</span><span class="va">pays</span>, group<span class="op">=</span><span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>stroke <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  col <span class="op">=</span> <span class="st">"white"</span>, shape <span class="op">=</span> <span class="fl">21</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>        aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span>,</span>
<span>        name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">cc</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span></span>
<span>      y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>minor.ticks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        y<span class="op">=</span><span class="st">"Ecart de taux à 10 ans"</span>,</span>
<span>        x<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>        colour<span class="op">=</span><span class="cn">NULL</span>,</span>
<span>        caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"*Source* : investing.com&lt;br&gt;Mis à jour : {date_maj}"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        labels <span class="op">=</span> <span class="op">~</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>        minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">main</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/base-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<p>On utilise la palette <em>summer</em> de <a href="https://nrennie.rbind.io/PrettyCols/" class="external-link">PrettyCols</a> (affaire de goût). On utilise la fonction <code><a href="../reference/theme_ofce.html">theme_ofce()</a></code> pour homogénéiser la présentation des graphiques. On précise les labels des axes inutile pour <code>x</code>, explicite pour <code>y</code>. Et la source, en notant que l’on peut utiliser <code>markdown</code> dans le texte de la source, ce qui permet de mettre <em>Source</em> en italique.</p>
<p>Le recours à <code><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date()</a></code> permet de spécifier facilement le format des dates (avec la syntaxe de <code><a href="https://rdrr.io/r/base/strptime.html" class="external-link">base::strptime()</a></code>) et la fonction <code>scale::label_date_short()</code> permet un formatage élégant des dates (voir plus bas la partie insert).</p>
<p>On ajoute au graphique des annotations. C’est ici faid de façon laborieuse, on peut construire des fonctions (formation R niv. 2) ou utiliser <a href="https://dreamrs.github.io/esquisse/" class="external-link">esquisse</a> ou <code>{gganotate}</code> mais ces deux solutions ont des défauts.</p>
</section><section class="level2"><h2 id="les-annotations">Les annotations<a class="anchor" aria-label="anchor" href="#les-annotations"></a>
</h2>
<p>Pour les annotations on peut utiliser différentes méthodes. La plus laborieuse est la fonction <code><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">ggplot2::annotate()</a></code>. La plus élégante est <code>ggforce::geom_mark_circle()</code> ou <code>ggrepel::geom_repel_text()</code>.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># méthode 1 : annotate</span></span>
<span></span>
<span><span class="va">annotations</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2013-12-01"</span><span class="op">)</span>, y<span class="op">=</span> <span class="fl">1</span>,</span>
<span>    label<span class="op">=</span><span class="st">"France"</span> , color<span class="op">=</span><span class="va">cc</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> , size<span class="op">=</span><span class="fl">3</span>, fontface <span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2010-06-01"</span><span class="op">)</span>, y<span class="op">=</span> <span class="fl">3</span> ,</span>
<span>    label<span class="op">=</span><span class="st">"Italie"</span> , color<span class="op">=</span><span class="va">cc</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, size<span class="op">=</span><span class="fl">3</span>, fontface <span class="op">=</span><span class="st">"bold"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2009-12-01"</span><span class="op">)</span>,</span>
<span>    y<span class="op">=</span> <span class="fl">5</span> ,</span>
<span>    label<span class="op">=</span><span class="st">"Crise des dettes souveraines\n26 juillet 2012 : Mario Draghi \n 'Whatever it takes'"</span> ,</span>
<span>    color<span class="op">=</span> <span class="st">"grey33"</span>,</span>
<span>    size<span class="op">=</span><span class="fl">2</span>,</span>
<span>    hjust<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"segment"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2010-03-01"</span><span class="op">)</span>,</span>
<span>    xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2011-07-01"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">5</span>,</span>
<span>    yend <span class="op">=</span> <span class="fl">4.6</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"grey33"</span>,</span>
<span>    linewidth<span class="op">=</span><span class="fl">0.25</span>,</span>
<span>    arrow<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"point"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>,</span>
<span>        x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2016-9-01"</span><span class="op">)</span>,</span>
<span>    y<span class="op">=</span> <span class="fl">4.5</span> ,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    label<span class="op">=</span><span class="st">"4 mars 2018 : Élections italiennes\n1er juin : gouvernement de coalition"</span> ,</span>
<span>    color<span class="op">=</span> <span class="st">"grey33"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"segment"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2016-09-01"</span><span class="op">)</span>,</span>
<span>    xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2018-05-01"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">4.2</span>,</span>
<span>    yend <span class="op">=</span> <span class="fl">3</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"grey33"</span>,</span>
<span>    linewidth<span class="op">=</span><span class="fl">0.25</span>,</span>
<span>    arrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"point"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"text"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-01-01"</span><span class="op">)</span>,</span>
<span>    hjust <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    y<span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    label<span class="op">=</span><span class="st">"Annonce de la dissolution"</span> ,</span>
<span>    color<span class="op">=</span> <span class="st">"grey33"</span>,</span>
<span>    size<span class="op">=</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>    <span class="st">"segment"</span>,</span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2022-03-01"</span><span class="op">)</span>,</span>
<span>    xend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-04-01"</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fl">0.8</span>,</span>
<span>    yend <span class="op">=</span> <span class="fl">0.7</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"grey33"</span>,</span>
<span>    linewidth<span class="op">=</span><span class="fl">0.25</span>,</span>
<span>    arrow<span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">4</span>, <span class="st">"point"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">main</span> <span class="op">+</span> <span class="va">annotations</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/annote-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># méthode 2 : ggrepel</span></span>
<span><span class="co"># on enrichit les données des labels,</span></span>
<span><span class="co"># le code est plus compact et surtout plus facile à manier</span></span>
<span><span class="co"># (pour modifier les annotations, on le fait dans les deux tribbles)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggrepel.slowkow.com/" class="external-link">ggrepel</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">date</span>, <span class="op">~</span><span class="va">pays</span>, <span class="op">~</span><span class="va">event</span>,</span>
<span>  <span class="st">"2012-01-02"</span>, <span class="st">"Italie"</span>, <span class="st">"Crise des dettes souveraines\n26 juillet 2012 : Mario Draghi \n 'Whatever it takes'"</span>,</span>
<span>  <span class="st">"2018-06-01"</span>, <span class="st">"Italie"</span>, <span class="st">"4 mars 2018 : Élections italiennes\n1er juin : gouvernement de coalition"</span>,</span>
<span>  <span class="st">"2024-06-10"</span>, <span class="st">"France"</span>, <span class="st">"Annonce de la dissolution"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">label_pays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">date</span>, <span class="op">~</span><span class="va">pays</span>,</span>
<span>  <span class="st">"2009-01-01"</span>, <span class="st">"Italie"</span>,</span>
<span>  <span class="st">"2013-12-01"</span>, <span class="st">"France"</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, <span class="st">"week"</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    label_pays <span class="op">=</span> <span class="va">pays</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">ss</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">events</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"pays"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">label_pays</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="st">"pays"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    label_pays <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">label_pays</span>, <span class="st">""</span><span class="op">)</span>,</span>
<span>    event <span class="op">=</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">event</span>, <span class="st">""</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">pays</span>, <span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="va">main</span> <span class="op"><a href="https://ggplot2.tidyverse.org/reference/gg-add.html" class="external-link">%+%</a></span> <span class="va">ss</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">label_pays</span>, color <span class="op">=</span> <span class="va">pays</span><span class="op">)</span>,</span>
<span>    fontface <span class="op">=</span> <span class="st">"bold"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">3</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    min.segment.length <span class="op">=</span> <span class="cn">Inf</span>,</span>
<span>    max.overlaps <span class="op">=</span> <span class="cn">Inf</span>, hjust <span class="op">=</span> <span class="fl">0.5</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://ggrepel.slowkow.com/reference/geom_text_repel.html" class="external-link">geom_text_repel</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">event</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"black"</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    segment.size <span class="op">=</span> <span class="fl">0.2</span>, min.segment.length <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    max.overlaps <span class="op">=</span> <span class="cn">Inf</span>, hjust <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>    nudge_x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">500</span>, <span class="op">-</span><span class="fl">250</span>, <span class="op">-</span><span class="fl">250</span><span class="op">)</span>, nudge_y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.3</span>, <span class="fl">1</span>, <span class="op">-</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>    arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.015</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>                     minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                     guide <span class="op">=</span> <span class="st">"axis_minor"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2008-01-01"</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/ggrepel-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<p>Le résultat est intéressant, mais le graphique a cependant un défaut, il y a trop de points, ce qui est du à la fréquence quotidienne et donc il perd en clarté. On va donc faire deux choses : réduire la fréquence en agrégeant les données par mois, puis on va ajouter un insert.</p>
</section><section class="level2"><h2 id="fréquence-mensuelle-et-insert">Fréquence mensuelle et insert<a class="anchor" aria-label="anchor" href="#fr%C3%A9quence-mensuelle-et-insert"></a>
</h2>
<p>Pour construire les données à la fréquence mensuelle, on va créer un champ de date, mais retenant une seule date par mois (au milieu du mois). En agrégeant par mois (<code>summarise</code>) on construit la série en mensuel.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spreads_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span><span class="op">$</span><span class="va">date</span></span>
<span><span class="co"># on force le jour à être le 15 du mois, il n'y aura qu'une date par mois!</span></span>
<span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/day.html" class="external-link">day</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">15</span></span>
<span><span class="va">spreads_m</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> date <span class="op">=</span> <span class="va">dates</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">pays</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>taux_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">taux</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            taux_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">taux</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            taux <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">taux</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">spreads_m</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code># A tibble: 422 × 5
# Groups:   date [211]
   date       pays   taux_max taux_min   taux
   &lt;date&gt;     &lt;fct&gt;     &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;
 1 2007-01-15 France   0.0580   0.0130 0.0409
 2 2007-01-15 Italie   0.278    0.154  0.229
 3 2007-02-15 France   0.0560   0.0380 0.0440
 4 2007-02-15 Italie   0.284    0.17   0.211
 5 2007-03-15 France   0.0630   0.0350 0.0466
 6 2007-03-15 Italie   0.318    0.192  0.239
 7 2007-04-15 France   0.0690   0.0410 0.0496
 8 2007-04-15 Italie   0.285    0.153  0.225
 9 2007-05-15 France   0.0980   0.0330 0.0464
10 2007-05-15 Italie   0.291    0.175  0.222
# ℹ 412 more rows</code></pre>
</div>
</div>
<p>On peut alors facilement modifier le graphique <code>main</code> en utilisant <code>%+%</code> (cette instruction modifie les données en entrée du graphique par le nouveau jeu de données qu’on vient de construire qui a exactement la même structure, comme on a utilisé les dates le passage du quotidien au mensuel se fait automatiquement, les axes sont parfaitement construits) :</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="va">main</span> <span class="op"><a href="https://ggplot2.tidyverse.org/reference/gg-add.html" class="external-link">%+%</a></span> <span class="va">spreads_m</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/logo-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<p>L’<em>insert</em> est le même graphique, en enlevant les annotations, en simplifiant les axes et en zoomant sur les deux derniers mois.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inset</span> <span class="op">&lt;-</span> <span class="va">main</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span></span>
<span>    base_size <span class="op">=</span> <span class="fl">7</span>,</span>
<span>    axis.line.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html" class="external-link">label_date_short</a></span><span class="op">(</span>format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"%Y"</span>, <span class="st">"%B"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">md</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-09"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-07-08"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                     minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                     guide <span class="op">=</span> <span class="st">"axis_minor"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, caption <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="va">inset</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/insert-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<p>On l’insère dans le graphique principal en utilisant <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a>, ce qui donne le graphique, plus lisible et plus élégant. Les paramètres de <code>inset</code> sont choisis après quelques essais et erreurs. On a réduit la taille de la police de caractère pour accentuer l’effet visuel.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">main_m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="op">(</span><span class="va">main</span> <span class="op">+</span> <span class="va">annotations</span><span class="op">)</span> <span class="op"><a href="https://ggplot2.tidyverse.org/reference/gg-add.html" class="external-link">%+%</a></span> <span class="va">spreads_m</span><span class="op">)</span></span>
<span><span class="va">main_m</span>  <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html" class="external-link">inset_element</a></span><span class="op">(</span><span class="va">inset</span>, <span class="fl">0.75</span>, <span class="fl">0.66</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/patchwork-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
<div id="tip-id">
<blockquote>
<p><strong>Tip 1: Une alternative avec {ggmagnify}</strong></p>
<p>Le package <a href="https://github.com/hughjonesd/ggmagnify" class="external-link">ggmagnify</a> simplifie la tâche et offre quelques améliorations esthétiques. Il faut cependant que les <em>dataset</em> principal et <em>inset</em> soit les mêmes [pas sûr en fait]. On reprend l’agrégation temporelle en l’arrêtant aux deux derniers mois. On complexifie l’insert pour intégrer plus d’éléments en utilisant l’argument <code>plot</code> de <code><a href="https://hughjonesd.github.io/ggmagnify/reference/geom_magnify.html" class="external-link">ggmagnify::geom_magnify()</a></code>.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># pak::pak("hughjonesd/ggmagnify")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hughjonesd/ggmagnify" class="external-link">ggmagnify</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">spreads_data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span><span class="va">date_inset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">md</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>, unit <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span></span>
<span><span class="va">spreads_hyb</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    date_h <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, unit <span class="op">=</span> <span class="st">"month"</span><span class="op">)</span>,</span>
<span>    date_h <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&lt;</span> <span class="va">date_inset</span>, <span class="va">date_h</span>, <span class="va">date</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date_h</span>, <span class="va">pays</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    taux <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">taux</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="va">date_h</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    date_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="fl">1</span>,</span>
<span>      <span class="fu"><a href="https://lubridate.tidyverse.org/reference/stamp.html" class="external-link">stamp</a></span><span class="op">(</span></span>
<span>        orders <span class="op">=</span> <span class="st">"%B %Y"</span>,</span>
<span>        locale <span class="op">=</span> <span class="st">"fr_FR.utf8"</span>, exact <span class="op">=</span> <span class="cn">TRUE</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://lubridate.tidyverse.org/reference/stamp.html" class="external-link">stamp</a></span><span class="op">(</span><span class="st">"22/12/2024"</span>,</span>
<span>        orders <span class="op">=</span> <span class="st">"%d/%m/%Y"</span>,</span>
<span>        locale <span class="op">=</span> <span class="st">"fr_FR.utf8"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span><span class="op">(</span><span class="va">date</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    tooltip <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span></span>
<span>      <span class="st">"&lt;b&gt;"</span>, <span class="va">pays</span>, <span class="st">"&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span>      <span class="va">date_label</span>,</span>
<span>      <span class="st">"&lt;br&gt;Ecart de taux avec l'Allemagne : "</span>, <span class="fu">f_taux</span><span class="op">(</span><span class="va">taux</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `tooltip = str_c(...)`.
Caused by error in `f_taux()`:
! could not find function "f_taux"</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inset_plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spreads_hyb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">taux</span>, fill <span class="op">=</span> <span class="va">pays</span>, color <span class="op">=</span> <span class="va">pays</span>, group <span class="op">=</span> <span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point_interactive</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    stroke <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>, shape <span class="op">=</span> <span class="fl">21</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">cc</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span></span>
<span>    base_size <span class="op">=</span> <span class="fl">7</span>,</span>
<span>    panel.grid.major.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gray"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span>,</span>
<span>    axis.line <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-6-30"</span><span class="op">)</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span>, color <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    colour <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    caption <span class="op">=</span> <span class="cn">NULL</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html" class="external-link">label_date_short</a></span><span class="op">(</span>format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"%Y"</span>, <span class="st">"%B"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_breaks <span class="op">=</span> <span class="st">"1 month"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error: object 'spreads_hyb' not found</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">from</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>, <span class="va">md</span>, <span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">md</span> <span class="op">-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">years</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span>, <span class="va">md</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">years</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="fl">3.75</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spreads_hyb</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">taux</span>, fill <span class="op">=</span> <span class="va">pays</span>, color <span class="op">=</span> <span class="va">pays</span>, group <span class="op">=</span> <span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">geom_point_interactive</span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    stroke <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>, shape <span class="op">=</span> <span class="fl">21</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">cc</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span>plot.margin <span class="op">=</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">60</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>minor.ticks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>minor.ticks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Ecart de taux à 10 ans"</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    colour <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"*Source* : investing.com&lt;br&gt;Mis à jour : {date_maj}"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html" class="external-link">label_date_short</a></span><span class="op">(</span>format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"%Y"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>    minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="st">"axis_minor"</span>,</span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">annotations</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">ggmagnify</span><span class="fu">::</span><span class="fu"><a href="https://hughjonesd.github.io/ggmagnify/reference/geom_magnify.html" class="external-link">geom_magnify</a></span><span class="op">(</span></span>
<span>    from <span class="op">=</span> <span class="va">from</span>, to <span class="op">=</span> <span class="va">to</span>, linewidth <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    colour <span class="op">=</span> <span class="st">"grey25"</span>, shadow <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    plot <span class="op">=</span> <span class="va">inset_plot</span>, axes <span class="op">=</span> <span class="st">"xy"</span>,</span>
<span>    shadow.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>sigma <span class="op">=</span> <span class="fl">5</span>, colour <span class="op">=</span> <span class="st">"grey80"</span>, x_offset <span class="op">=</span> <span class="fl">5</span>, y_offset <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error: object 'spreads_hyb' not found</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/girafy.html">girafy</a></span><span class="op">(</span><span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="va">sh</span><span class="op">)</span>, r <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error: object 'sh' not found</code></pre>
</div>
</div>
</blockquote>
</div>
</section><section class="level2"><h2 id="linteractivité">L’interactivité<a class="anchor" aria-label="anchor" href="#linteractivit%C3%A9"></a>
</h2>
<p>La dernière étape est l’interactivité. On utilise le package <a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a> qui va permettre d’intégrer des <em>tooltips</em> très simplement et très efficacement. On peut aussi avec des sélections dynamiques ou encore des zooms.</p>
<p>Pour ajouter l’interactivité, la première étape est de générer le texte des <em>tooltips</em> dans le tableau de données. Notez l’utilisation de <code><a href="https://lubridate.tidyverse.org/reference/stamp.html" class="external-link">lubridate::stamp_date()</a></code> pour formater les dates simplement.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spreads_m</span> <span class="op">&lt;-</span> <span class="va">spreads_m</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    tooltip <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"&lt;b&gt;"</span>, <span class="va">pays</span>, <span class="st">"&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span>                    <span class="fu"><a href="https://lubridate.tidyverse.org/reference/stamp.html" class="external-link">stamp</a></span><span class="op">(</span>exact <span class="op">=</span> <span class="cn">TRUE</span>, orders <span class="op">=</span> <span class="st">"%B %Y"</span>,</span>
<span>                          locale <span class="op">=</span> <span class="st">"fr_FR.utf8"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>                    <span class="st">"&lt;br&gt;Ecart de taux avec l'Allemagne : "</span>, <span class="fu">f_taux</span><span class="op">(</span><span class="va">taux</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `tooltip = str_c(...)`.
ℹ In group 1: `date = 2007-01-15`.
Caused by error in `f_taux()`:
! could not find function "f_taux"</code></pre>
</div>
</div>
<p>L’interactivité est alors ajoutée par des instructions spécifiques qui se substituent aux <code>geom_*</code> en ajoutant un suffix, <code>geom_*_interactive</code>. Ces <code>geom_*_interactive</code> acceptent un <code>aes</code> avec deux paramètres supplémentaire, le premier définissant le <code>tooltip</code> et le second, <code>data_id</code>, une variable qui relie les éléments graphiques entre eux pour qu’ils soient modifiés lors du survol avec la souris. La fonction <code>girafy</code> qui est définie par <code>source("rinit.r")</code> et finalise le rendu. <a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a> conserve tous les éléments du graphique et il est possible de l’appliquer avec <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> pour combiner les interactivités.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a></span><span class="op">)</span></span>
<span><span class="va">main_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spreads_m</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">taux</span>, color <span class="op">=</span> <span class="va">pays</span>, group <span class="op">=</span> <span class="va">pays</span>, fill <span class="op">=</span> <span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/geom_point_interactive.html" class="external-link">geom_point_interactive</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    stroke <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"white"</span>, shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>    hover_nearest <span class="op">=</span> <span class="cn">TRUE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">cc</span>, aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Ecart de taux à 10 ans"</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    caption <span class="op">=</span> <span class="st">"Source: investing.com"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_axis.html" class="external-link">guide_axis</a></span><span class="op">(</span>minor.ticks <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    colour <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"*Source* : investing.com&lt;br&gt;Mis à jour : {date_maj}"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html" class="external-link">label_date_short</a></span><span class="op">(</span>format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"%Y"</span>, <span class="st">"%B"</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">spreads_data</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    tooltip <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span></span>
<span>      <span class="st">"&lt;b&gt;"</span>, <span class="va">pays</span>, <span class="st">"&lt;/b&gt;&lt;br&gt;"</span>,</span>
<span>      <span class="fu"><a href="https://lubridate.tidyverse.org/reference/stamp.html" class="external-link">stamp_date</a></span><span class="op">(</span><span class="st">"24/7/2024"</span>, locale <span class="op">=</span> <span class="st">"fr_FR.utf8"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>      <span class="st">"&lt;br&gt;Ecart de taux avec l'Allemagne : "</span>, <span class="fu">f_taux</span><span class="op">(</span><span class="va">taux</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in `mutate()`:
ℹ In argument: `tooltip = str_c(...)`.
Caused by error in `f_taux()`:
! could not find function "f_taux"</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inset_i</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">main_i</span> <span class="op"><a href="https://ggplot2.tidyverse.org/reference/gg-add.html" class="external-link">%+%</a></span> <span class="va">spreads_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span></span>
<span>    base_size <span class="op">=</span> <span class="fl">7</span>,</span>
<span>    axis.line.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    axis.line.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    plot.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html" class="external-link">scale_x_date</a></span><span class="op">(</span></span>
<span>    labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/label_date.html" class="external-link">label_date_short</a></span><span class="op">(</span>format <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"%Y"</span>, <span class="st">"%B"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_breaks <span class="op">=</span> <span class="st">"1 month"</span>,</span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"1 week"</span>,</span>
<span>    limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">md</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/weekday.POSIXt.html" class="external-link">months</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="cn">NA</span><span class="op">)</span>,</span>
<span>    guide <span class="op">=</span> <span class="st">"minor_ticks"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="st">"2024-06-09"</span><span class="op">)</span>,</span>
<span>    linewidth <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"grey50"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>                     limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                     minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                     guide <span class="op">=</span> <span class="st">"axis_minor"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="cn">NULL</span>, caption <span class="op">=</span> <span class="cn">NULL</span>, color <span class="op">=</span> <span class="cn">NULL</span>, fill <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span><span class="va">main_i</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="op">(</span><span class="va">main_i</span> <span class="op">+</span> <span class="va">annotations</span><span class="op">)</span> <span class="op"><a href="https://ggplot2.tidyverse.org/reference/gg-add.html" class="external-link">%+%</a></span> <span class="va">spreads_m</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">main_i</span> <span class="op">&lt;-</span> <span class="va">main_i</span> <span class="op">+</span> <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/inset_element.html" class="external-link">inset_element</a></span><span class="op">(</span><span class="va">inset_i</span>, <span class="fl">0.75</span>, <span class="fl">0.66</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/girafy.html">girafy</a></span><span class="op">(</span><span class="va">main_i</span>, r <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error:
! Problem while computing aesthetics.
ℹ Error occurred in the 2nd layer.
Caused by error:
! object 'tooltip' not found</code></pre>
</div>
</div>
<p>La clef pour l’interactivité est d’apporter de l’information à l’utilisateur par le texte du <em>tooltip</em>. Il est possible d’avoir des interactivités plus avancées, en déclenchant une action sur un <em>click</em> par exemple. L’approche par <a href="https://davidgohel.github.io/ggiraph/" class="external-link">ggiraph</a> est applicable simplement à de nombreux graphiques avec un rendu satisfaisant. Cela marche également pour des <code>facet</code> et donc ça ouvre beaucoup de possibilités.</p>
</section><section class="level2"><h2 id="fréquence-trimestrielle">Fréquence trimestrielle<a class="anchor" aria-label="anchor" href="#fr%C3%A9quence-trimestrielle"></a>
</h2>
<p>On transforme les données en fréquence trimestrielle en utilisant la fonction <code><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">lubridate::floor_date()</a></code>. En calculant les variables année (<code>y</code>) et trimestre (<code>q</code>), on peut avec le package <a href="https://github.com/teunbrand/ggh4x" class="external-link">ggh4x</a> produire facilement un joli graphique trimestriel. Les clefs sont de mettre en x l’interaction entre ces deux éléments discrets (attention à l’ordre, attention à trier les données avec <code>arrange</code>). La magie opère ensuite avec <code>guide = "axis_nested"</code>. Cete fonction est généralisable à bien des cas.</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="co"># pak::pak("teunbrand/ggh4x")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/teunbrand/ggh4x" class="external-link">ggh4x</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">spreads_q</span> <span class="op">&lt;-</span> <span class="va">spreads_data</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span>,</span>
<span>    q <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="st">"T"</span>, <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/quarter.html" class="external-link">quarter</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    date_q <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html" class="external-link">floor_date</a></span><span class="op">(</span><span class="va">date</span>, unit <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">date_q</span>, <span class="va">y</span>, <span class="va">q</span>, <span class="va">pays</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    taux_max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">taux</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    taux_min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">taux</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    taux <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">taux</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"drop"</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">date_q</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;=</span> <span class="st">"2018-01-01"</span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">spreads_q</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html" class="external-link">interaction</a></span><span class="op">(</span><span class="va">q</span>, <span class="va">y</span><span class="op">)</span>, y <span class="op">=</span> <span class="va">taux</span>, fill <span class="op">=</span> <span class="va">pays</span>, color <span class="op">=</span> <span class="va">pays</span>, group <span class="op">=</span> <span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>linewidth <span class="op">=</span> <span class="fl">0.75</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    stroke <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>, shape <span class="op">=</span> <span class="fl">21</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span></span>
<span>    aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"color"</span><span class="op">)</span>,</span>
<span>    name <span class="op">=</span> <span class="cn">NULL</span>, values <span class="op">=</span> <span class="va">cc</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span></span>
<span>    axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">0.8</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    ggh4x.axis.nesttext.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">rel</a></span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span>, margin <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">margin</a></span><span class="op">(</span>t <span class="op">=</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="st">"Ecart de taux à 10 ans"</span>,</span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    colour <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"*Source* : investing.com&lt;br&gt;Mis à jour : {date_maj}"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="op">~</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_c.html" class="external-link">str_c</a></span><span class="op">(</span><span class="va">.x</span>, <span class="st">"%"</span><span class="op">)</span>,</span>
<span>                     minor_breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_width.html" class="external-link">breaks_width</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                     guide <span class="op">=</span> <span class="st">"axis_minor"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_x_discrete</a></span><span class="op">(</span>guide <span class="op">=</span> <span class="st">"axis_nested"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/add_logo.html">add_logo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output-display">
<div>
<figure><p><img src="temporelles_files/figure-html/trim-1.svg" style="width:100.0%" data-fig-pos="htb"></p>
</figure>
</div>
</div>
</div>
</section><section class="level2"><h2 id="double-échelle">Double échelle<a class="anchor" aria-label="anchor" href="#double-%C3%A9chelle"></a>
</h2>
<p>Non mais ca va pas ?</p>
</section><section class="level2"><h2 id="une-dernière-chose-la-mise-à-dispostion-des-données">Une dernière chose : la mise à dispostion des données<a class="anchor" aria-label="anchor" href="#une-derni%C3%A8re-chose-la-mise-%C3%A0-dispostion-des-donn%C3%A9es"></a>
</h2>
<p>Une bonne pratique est de mettre à disposition les données et le code ayant servi à produire le graphique. Une façon est d’utiliser les boutons code présents dans ce document pour publier le code. La seconde est de mettre tous les codes sur un dépôt github 😸 public.</p>
<p>A minima, on ajoute un bouton pour télécharger les données. C’est simple à faire avec <a href="https://github.com/fmmattioni/downloadthis" class="external-link">downloadthis</a> et ce bout de code qui peut être mis juste après un graphique. On reprend le fichier de données, tel quel, modifié éventuellement pour enlever ou renommer une colonne, et qui sera disponible en csv, UTF8, avec des virgules comme sépérateurs et des points comme marque décimale (i.e. pas ce qu’Excel attend ☠️).</p>
<p>Pour que les boutons soient sur la même ligne on utilise la syntaxe <em>inline</em> <code>'r une_expression_R'</code> :</p>
<div class="cell" data-fenced="true">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/fmmattioni/downloadthis" class="external-link">downloadthis</a></span><span class="op">)</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/downloadthis/man/download_this.html" class="external-link">download_this</a></span><span class="op">(</span></span>
<span>  <span class="va">spreads_m</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tooltip</span><span class="op">)</span>,</span>
<span>  icon <span class="op">=</span> <span class="st">"fa fa-download"</span>,</span>
<span>  class <span class="op">=</span> <span class="st">"dbtn"</span>,</span>
<span>  button_label  <span class="op">=</span> <span class="st">"Taux mensuels"</span>,</span>
<span>  output_name <span class="op">=</span> <span class="st">"taux_mensuels"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details><div class="cell-output cell-output-error">
<pre><code>Error in `select()`:
! Can't select columns that don't exist.
✖ Column `tooltip` doesn't exist.</code></pre>
</div>
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/downloadthis/man/download_this.html" class="external-link">download_this</a></span><span class="op">(</span></span>
<span>  <span class="va">spreads_data</span>,</span>
<span>  icon <span class="op">=</span> <span class="st">"fa fa-download"</span>,</span>
<span>  class <span class="op">=</span> <span class="st">"dbtn"</span>,</span>
<span>  button_label  <span class="op">=</span> <span class="st">"Taux quotidiens"</span>,</span>
<span>  output_name <span class="op">=</span> <span class="st">"taux_quotidiens"</span></span>
<span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<p>On peut aussi les mettre dans la marge en entourant le chunk R de <code>::: column-margin ⏎ un_code_r ⏎ :::</code> (visuellement c’est mieux quand il y a le graphique juste avant le div).</p>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul Malliet, Anissa Saumtally, Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>RTFM CC BY 4.0 Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
