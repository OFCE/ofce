<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Séries temporelles II : les graphiques de prévision • ofce</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Open_Sans-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Fira_Code-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="prevision_files/libs/quarto-html/popper.min.js"></script><script src="prevision_files/libs/quarto-html/tippy.umd.min.js"></script><link href="prevision_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="prevision_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Séries temporelles II : les graphiques de prévision">
<meta property="og:image" content="https://ofce.github.io/ofce/logo.png">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ofce</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.15</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-manuels" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Manuels</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-manuels">
<li><a class="dropdown-item" href="../articles/site.html">Sites dédiés</a></li>
    <li><a class="dropdown-item" href="../articles/blog.html">Le Blog</a></li>
    <li><a class="dropdown-item" href="../articles/quarto.html">Ecrire un texte en quarto</a></li>
    <li><a class="dropdown-item" href="../articles/graphiques.html">Faire un graphique</a></li>
    <li><a class="dropdown-item" href="../articles/tableaux.html">Faire un tableau</a></li>
    <li><a class="dropdown-item" href="../articles/outils.html">Les outils</a></li>
    <li><a class="dropdown-item" href="../articles/semio.html">Le language des graphiques</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tutoriaux" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tutoriaux</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tutoriaux">
<li><a class="dropdown-item" href="../articles/charte_graphique.html">Charte Graphique</a></li>
    <li><a class="dropdown-item" href="../articles/prevision.html">Charte Graphique pour la Prévision</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/temporelles.html">Séries temporelles</a></li>
    <li><a class="dropdown-item" href="../articles/xy.html">Graphiques XY</a></li>
    <li><a class="dropdown-item" href="../articles/categories.html">Barres empilées, wafle, treemap, lollypop</a></li>
    <li><a class="dropdown-item" href="../articles/distributions.html">Distributions</a></li>
    <li><a class="dropdown-item" href="../articles/cartes.html">Cartes</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/source_data.html">Caché et robuste</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/qa.html">Quand ça ne marche pas</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ofce/ofce"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Séries temporelles II : les graphiques de prévision</h1>





      <div class="d-none name"><code></code></div>
    </div>






    <div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zz</span> <span class="op">&lt;-</span> <span class="fu">ofce</span><span class="fu">::</span><span class="fu"><a href="../reference/init_qmd.html">init_qmd</a></span><span class="op">(</span>echo<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">annotate_prevision</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">posy</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">xstart</span> <span class="op">=</span> <span class="st">"2025-01-01"</span>, <span class="va">xend</span> <span class="op">=</span> <span class="st">"2026-12-31"</span>, <span class="va">ymin</span> <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, <span class="va">ymax</span> <span class="op">=</span> <span class="cn">Inf</span>, <span class="va">size</span> <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">midx</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">xend</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">xstart</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">xstart</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>      <span class="st">"rect"</span>,</span>
<span>      xmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">xstart</span><span class="op">)</span>, xmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">xend</span><span class="op">)</span>,</span>
<span>      ymin <span class="op">=</span> <span class="va">ymin</span>, ymax <span class="op">=</span> <span class="va">ymax</span>, alpha <span class="op">=</span> <span class="fl">0.2</span>, fill <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span>,</span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span></span>
<span>      <span class="st">"text"</span>,</span>
<span>      x<span class="op">=</span><span class="va">midx</span>, y <span class="op">=</span> <span class="va">posy</span>,</span>
<span>      label<span class="op">=</span><span class="st">"Prévisions"</span>, size <span class="op">=</span> <span class="va">size</span>,</span>
<span>      color<span class="op">=</span><span class="st">"grey20"</span>, hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">zz</span></span></code></pre></div>
</details><div class="cell-output cell-output-stdout">
<pre><code>rinit.r not found (nor in project, nor in package)</code></pre>
</div>
</div>
<section class="level2"><h2 id="les-graphiques-de-prévision">Les graphiques de prévision<a class="anchor" aria-label="anchor" href="#les-graphiques-de-pr%C3%A9vision"></a>
</h2>
<p>Le but est d’homogénéiser le plus possible les graphiques de prévisions. Les consignes s’appliquent surtout aux graphiques en séries temporelles, avec une fréquence de données trimestrielle. Les consignes sont quasi obligatoires (i.e. obligatoires sauf très bonne raison de ne pas les suivre).</p>
<ol type="1">
<li>
<p>On suit d’abord les consignes qui valent pour les graphiques de <a href="temporelles.html">séries temporelles</a></p>
<ol type="1">
<li><p><code><a href="../reference/theme_ofce.html">theme_ofce()</a></code>,</p></li>
<li><p>format <code>&lt;date&gt;</code>, et on appelle sa colonne d’index temporel <code>time</code> ; les dates sont au format quotidien (<code>"2024-01-31"</code>) par exemple. Par convention, on note les données trimestrielles <code>"yyyy-[01; 04; 07; 10]-01"</code> et les années au premier janvier (mais voir plus bas pour une nuance importante).</p></li>
<li><p><code><a href="../reference/scale_ofce_date.html">scale_ofce_date()</a></code>,</p></li>
<li><p>On utilise les options pour le <code>geom_point_interactive(linewidth=0.5, shape=21, stroke=0.25, col="white", hover_nearest=TRUE</code>)</p></li>
<li><p>Chaque .<code>qmd</code> doit commencer par un chunk <code>r</code> qui est formaté comme suit – cette instruction charge les packages nécessaires, définit des options par défaut et ajoute quelques fonctions utiles :</p></li>
</ol>
</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#| include: false</span></span>
<span><span class="fu">ofce</span><span class="fu">::</span><span class="fu"><a href="../reference/init_qmd.html">init_qmd</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<ol start="2" type="1">
<li><p>On évite les graphiques spaghetti, double échelle. On privilégie les <code>facets</code> et si possible on répète en gris clair les données des autres <code>facets</code> pour permettre la comparaison.</p></li>
<li><p>On place la légende, dans la mesure du possible, dans le graphique. Dans la mesure du possible, on met la légende sous forme de labels.</p></li>
<li><p>On indique, lorsque c’est pertinent, la période de prévision par un grisé et en utilisant la fonction <code>annotate_prevision(posy = y)</code>, où <code>y</code> est la coordonnée à laquelle on veut que le texte “prévisions” s’affiche (si <code>size=0</code> il n’y aura pas de texte). On n’utilise pas d’autres moyens pour indiquer les prévisions (par exemple des pointillés).</p></li>
<li>
<p>On rend le graphique interactif, en utilisant <code>girafy</code> et :</p>
<ol type="1">
<li><p>avec un <code>geom_point_interactive(aes(tooltip=tooltip, data_id = time))</code> – et donc pas d’autres éléments interactifs sauf si nécessaire (notamment les barres),</p></li>
<li><p>en construisant un <code>tooltip</code> le plus signifiant possible,</p></li>
<li><p>en mettant à disposition les données avec un <code>margin_download()</code>,</p></li>
</ol>
</li>
<li><p>On utilise <code><a href="../reference/ofce_caption.html">ofce::ofce_caption()</a></code> afin de normaliser l’aspect et la présentation des notes de graphique. <code><a href="../reference/ofce_caption.html">ofce_caption()</a></code> permet de spécifier la source, les notes, les indications de lecture, le champ, le lien vers le code, un texte comme “prévisions OFCE 2025” systématique, etc… (reportez vous à l’aide de cette fonction qui est dans le package <a href="https://ofce.github.io/ofce">ofce</a>).</p></li>
<li><p>On met le code du graphique (le <code>ggplot</code>, etc…) dans le <code>.qmd</code> qui contient le texte. Cela permet d’éditer les textes, d’un côté, et de normaliser les présentations, de l’autre. La construction du tooltip est aussi à ce niveau pour pouvoir l’éditer. Il est <strong>nécessaire que le <code>girafy()</code> soit dans le <code>qmd</code></strong>, sinon, l’objet interactif n’aura pas le bon format suivant les support (site, présentation, etc…).</p></li>
<li><p>On utilise <code>ofce::source_data()</code> pour la construction des données, ce n’est pas obligatoire, mais très efficace et très recommandé pour le travail collaboratif (comme celui de la prévision). Voir <a href="source_data.html">la vignette correspondante</a>. On met le code de construction dans un fichier <code>.r</code>, joint dont le nom est simple, signifiant, en minuscule et qui est enregistré au même niveau que le <code>.qmd</code> ou en dessous. On utilise <code>source_data</code> pour éviter de bloquer le fonctionnement de la compilation des <code>qmd</code> et faciliter la portabilité des codes de données – <strong>c’est important</strong>.</p></li>
</ol>
<p>Chacun de ces éléments est détaillés et avec des exemples de codes ci-dessous.</p>
</section><section class="level2"><h2 id="un-exemple-de-graphique">Un exemple de graphique<a class="anchor" aria-label="anchor" href="#un-exemple-de-graphique"></a>
</h2>
<p>L’exemple de graphique est celui qui apparaît sur toutes les fiches et la partie France en début de texte. Les données sont stockées dans un fichier excel, ce qui est une pratique qui devra disparaître, mais bon… Le code original se trouve dans le répertoire d’une prévision (<code>fiches/data_pays.R</code>). Il est ici un peu simplifié, parce que <code>data_pays.R</code> produit une fonction qui prend comme paramètre le pays qu’on veut afficher. C’est donc le même code pour tous les pays.</p>
<p>Il y a d’autres exemples dans le cahier de graphiques et les codes sont copiables directement.</p>
<section class="level3"><h3 id="chargement-des-données-et-tooltip">Chargement des données et <em>tooltip</em>
<a class="anchor" aria-label="anchor" href="#chargement-des-donn%C3%A9es-et-tooltip"></a>
</h3>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gt</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">1</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ga</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">(</span><span class="fl">100</span><span class="op">*</span><span class="op">(</span><span class="va">x</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span>,<span class="fl">4</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data_pays</span> <span class="op">&lt;-</span> <span class="fu">fs</span><span class="fu">::</span><span class="fu"><a href="https://fs.r-lib.org/reference/path_package.html" class="external-link">path_package</a></span><span class="op">(</span><span class="st">"ofce"</span>, <span class="st">"extdata/data_pays.xlsx"</span><span class="op">)</span></span>
<span><span class="va">data_gpib</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="va">data_pays</span>, sheet <span class="op">=</span> <span class="st">"pib"</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span><span class="fu">across</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">usa</span>, <span class="va">euz</span>, <span class="va">deu</span>, <span class="va">fra</span> , <span class="va">ita</span>, <span class="va">esp</span>, <span class="va">gbr</span>, <span class="va">jpn</span><span class="op">)</span>, <span class="op">~</span><span class="fu">gt</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="op">-</span><span class="va">date</span>, names_to<span class="op">=</span> <span class="st">"pays"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span>  <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="st">"Croissance du PIB"</span>,</span>
<span>    long <span class="op">=</span> <span class="va">pays_long</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">pays</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    tooltip <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"&lt;b&gt;{long}&lt;/b&gt;&lt;br&gt;{date_trim(date)}&lt;br&gt;croissance trimestrielle du PIB : {round(value,1)}%"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_tcho</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="va">data_pays</span>, sheet <span class="op">=</span> <span class="st">"tcho"</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="op">-</span><span class="va">date</span>, names_to<span class="op">=</span><span class="st">"pays"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="st">"Chômage"</span>,</span>
<span>    long <span class="op">=</span> <span class="va">pays_long</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">pays</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    tooltip <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"&lt;b&gt;{long}&lt;/b&gt;&lt;br&gt;{date_trim(date)}&lt;br&gt;Taux de chômage : {round(value,1)}% de la population active"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_prix</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="va">data_pays</span>, sheet <span class="op">=</span> <span class="st">"prix"</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">45</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">mutate_at</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"usa"</span>, <span class="st">"euz"</span>,<span class="st">"deu"</span>,<span class="st">"fra"</span>,<span class="st">"ita"</span>,<span class="st">"esp"</span>,<span class="st">"gbr"</span>,<span class="st">"jpn"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">~</span><span class="fu">ga</span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="op">-</span><span class="va">date</span>, names_to<span class="op">=</span><span class="st">"pays"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    variable <span class="op">=</span> <span class="st">"Inflation (prix à la consommation)"</span>,</span>
<span>    long <span class="op">=</span> <span class="va">pays_long</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">pays</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    tooltip <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"&lt;b&gt;{long}&lt;/b&gt;&lt;br&gt;{date_trim(date)}&lt;br&gt;Glissement annuel des prix : {round(value,1)}%"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_solde</span> <span class="op">&lt;-</span> <span class="fu">read_excel</span><span class="op">(</span><span class="va">data_pays</span>, sheet <span class="op">=</span> <span class="st">"solde"</span>, col_names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">-</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/period.html" class="external-link">days</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>  <span class="fu">pivot_longer</span><span class="op">(</span>cols<span class="op">=</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date"</span><span class="op">)</span>, names_to<span class="op">=</span><span class="st">"pays"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>value<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    date <span class="op">=</span> <span class="va">date</span>,</span>
<span>    variable <span class="op">=</span> <span class="st">"Solde public (APU)"</span>,</span>
<span>    long <span class="op">=</span> <span class="va">pays_long</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">pays</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    tooltip <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"&lt;b&gt;{long}&lt;/b&gt;&lt;br&gt;{year(date)} (fin d'année)&lt;br&gt;Solde des administrations publiques : {round(value,1)}%"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">bind_rows</span><span class="op">(</span><span class="va">data_gpib</span>, <span class="va">data_tcho</span>, <span class="va">data_prix</span>, <span class="va">data_solde</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op">&gt;</span> <span class="st">"2020-12-31"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span></span>
<span>    pays <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/chartr.html" class="external-link">toupper</a></span><span class="op">(</span><span class="va">pays</span><span class="op">)</span>,</span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>    <span class="va">variable</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Croissance du PIB"</span>, <span class="st">"Chômage"</span>, <span class="st">"Inflation (prix à la consommation)"</span>, <span class="st">"Solde public (APU)"</span> <span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<p>Les données, dans <code>data</code>, sont en format long, c’est à dire en ligne pour les dates, les pays et les variables. Rien de particulier à ce stade, si ce n’est la construction du tooltip, pour chaque ligne de <code>data</code>. On choisit un pays qui sera le principal, on fait un <code>facet</code> sur les <em>variables</em> (pib, chômage, inflation, déficit), et on ajoute les autres pays dans le fond, en gris clair pour la comparaison. Ce chunk peut tout à fait être dans un script <code>r</code> (<code>data.r</code>)<a class="footnote-ref" role="doc-noteref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Un nom plus signifiant devra être trouvé. Si tout le monde construit ses données dans un script &lt;code&gt;data.r&lt;/code&gt;, ca va faire des conflits.&lt;/p&gt;"><sup>1</sup></a> et on utilise alors <code>source_data</code> pour l’exécuter avec <code>data &lt;- source_data("data.r")</code>.</p>
</section></section><section class="level2"><h2 id="graphique-proprement-dit">Graphique proprement dit<a class="anchor" aria-label="anchor" href="#graphique-proprement-dit"></a>
</h2>
<p>Le graphique est construit ensuite par un <code>ggplot</code> et la mise en oeuvre des recommandations ci-dessus :</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="annotated-cell-4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pays</span> <span class="op">&lt;-</span> <span class="st">"FRA"</span></span>
<span><span class="va">pays2</span> <span class="op">&lt;-</span> <span class="st">"EUZ"</span></span>
<span><span class="co"># on définit les données, le pays en évidence, `pays2` moins mis en évidence et `autres` pas mis en évidence du tout</span></span>
<span><span class="va">autres</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span> <span class="fu">distinct</span><span class="op">(</span><span class="va">pays</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu">pull</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pays</span>, <span class="va">pays2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># l'`aes` commun à plusieurs geom, une bonne pratique qui rend le code plus simple</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">value</span>, group <span class="op">=</span> <span class="va">pays</span>, color <span class="op">=</span> <span class="va">variable</span>, fill <span class="op">=</span> <span class="va">variable</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># la bande grise qui indique les prévisions (spécifique à chque exercice de prévision)</span></span>
<span>  <span class="fu">annotate_prevision</span><span class="op">(</span>size<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># le `facet`, avec une échelle libre sur les y -- jamais de spaghettis</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">variable</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># dans ce geom_line on filtre les pays en fond de graphique, qui sont en gris clair et en trait fin ce qui peut se faire aussi avec le pkg `{highlitght}`</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span>  <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">autres</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"gray85"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span><span class="op">==</span><span class="va">pays2</span><span class="op">)</span>,</span>
<span>            size <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="st">"gray35"</span>, linewidth <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># le premier geom_point_interactive, pour les pays du fond, en gris clair</span></span>
<span>  <span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/geom_point_interactive.html" class="external-link">geom_point_interactive</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span>  <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">autres</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.75</span>, stroke <span class="op">=</span> <span class="fl">0.25</span>, shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"gray85"</span>,</span>
<span>    hover_nearest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># le second geom_point_interactive() pour le pays moins en évidence en gris foncé</span></span>
<span>  <span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/geom_point_interactive.html" class="external-link">geom_point_interactive</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="op">~</span><span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span><span class="op">==</span><span class="va">pays2</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    size <span class="op">=</span> <span class="fl">0.75</span>, stroke <span class="op">=</span> <span class="fl">0.25</span>, shape <span class="op">=</span> <span class="fl">21</span>,</span>
<span>    col <span class="op">=</span> <span class="st">"white"</span>, fill <span class="op">=</span> <span class="st">"gray35"</span>,</span>
<span>    hover_nearest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># les lignes colorées (en fonction des variables, voir l'`aes`) pour le pays principal (notez `!!pays` qui signifie utiliser la variable globale, pas celle du data.frame)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="op">~</span> <span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span><span class="op">==</span><span class="op">!</span><span class="op">!</span><span class="va">pays</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># les points pour le pays principal, de `shape 21` et colorés par `fill` avec un cercle blanc</span></span>
<span>  <span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/geom_point_interactive.html" class="external-link">geom_point_interactive</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="op">~</span> <span class="va">.x</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">pays</span><span class="op">==</span><span class="op">!</span><span class="op">!</span><span class="va">pays</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>    stroke <span class="op">=</span> <span class="fl">0.5</span>, shape <span class="op">=</span> <span class="fl">21</span>, col <span class="op">=</span> <span class="st">"white"</span>, hover_nearest <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># l'échelle des dates qui utilise la fonction du package `{ofce}`, avec des ticks mineurs pour les trimestres</span></span>
<span>  <span class="fu"><a href="../reference/scale_ofce_date.html">scale_ofce_date</a></span><span class="op">(</span></span>
<span>    date_breaks <span class="op">=</span> <span class="st">"1 year"</span>,</span>
<span>    date_minor_breaks <span class="op">=</span> <span class="st">"3 months"</span>,</span>
<span>    expand <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/expansion.html" class="external-link">expansion</a></span><span class="op">(</span>mult<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># les labels des axes, on garde ça simple et on indique principalement l'unité</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y<span class="op">=</span><span class="st">"En %"</span>, x<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># le theme ofce (l'ordre des éléments n'est pas critique) !!!</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># les couleurs : procéder ainsi permet la normalisation des couleurs a posteriori</span></span>
<span>  <span class="fu">PrettyCols</span><span class="fu">::</span><span class="fu"><a href="https://nrennie.github.io/PrettyCols/reference/scale_color_pretty_d.html" class="external-link">scale_color_pretty_d</a></span><span class="op">(</span><span class="st">"Summer"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu">PrettyCols</span><span class="fu">::</span><span class="fu"><a href="https://nrennie.github.io/PrettyCols/reference/scale_fill_pretty_d.html" class="external-link">scale_fill_pretty_d</a></span><span class="op">(</span><span class="st">"Summer"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># l'aspect des labels, avec le bon nombre de chiffres après la virgule et l'utilisation de `scales::pretty_breaks()` pour des labels choisis astucieusement</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">label_number</span><span class="op">(</span>decimal.mark <span class="op">=</span> <span class="st">","</span>, accuracy <span class="op">=</span> <span class="fl">1</span>, suffix <span class="op">=</span> <span class="st">"%"</span><span class="op">)</span>,</span>
<span>                     breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_pretty.html" class="external-link">breaks_pretty</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># on ne met pas les légendes de couleur ou de remplissage, ce n'est pas utile dans ce graphique, on essaye de ne pas les mettre en dessous de façon générale si elles sont nécessaire</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"none"</span>, fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># les notes et sources, standardisées, avec en particulier les derniers points connus.</span></span>
<span>  <span class="fu"><a href="../reference/ofce_caption.html">ofce_caption</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"INSEE, Eurostat, instituts nationaux"</span>,</span>
<span>    note <span class="op">=</span> <span class="st">"La zone euro est en gris foncé"</span>,</span>
<span>    dpt <span class="op">=</span> <span class="st">"2024-04-01"</span>, dptf <span class="op">=</span> <span class="st">"quarter"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gg</span></span></code></pre></div>
</details>
</div>
</section><section class="level2"><h2 id="des-couleurs-par-pays">Des couleurs par pays<a class="anchor" aria-label="anchor" href="#des-couleurs-par-pays"></a>
</h2>
<p>La fonction <code><a href="../reference/scale_color_pays.html">ofce::scale_color_pays()</a></code> applique une échelle de couleur (et de remplissage) qui suit le choix de la charte graphique de l’ofce. Pour que cela fonctionne, il faut que dans l’aes qui définit la couleur (<code>aes(color=pays)</code>) ou le remplissage (<code>aes(fill=pays)</code>) soit un code iso à 3 lettres. Si le code est un code eurostat il suffit de le préciser (<code>format="eurostat"</code> en paramètre à scale_color_pays()).</p>
<p>Cela donne comme code :</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mes_donnees</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span> <span class="va">pib</span>, color <span class="op">=</span> <span class="va">pays</span>, fill <span class="op">=</span> <span class="va">pays</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">...</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/scale_color_pays.html">scale_color_pays</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</section><section class="level2"><h2 id="interactivité">Interactivité<a class="anchor" aria-label="anchor" href="#interactivit%C3%A9"></a>
</h2>
<p>Pour finir, on enveloppe le graphique d’un <code>girafy</code>, qui fait fonctionner et normalise l’interactivité (dont les <code>tooltips</code>). On peut demander aussi à ce stade d’inclure l’instruction <code>graph2prev(gg)</code> qui effectue un enregistrement du graphique pour usages ultérieurs (par exemple dans une présentation).</p>
<div class="cell">
<details class="code-fold"><summary>code</summary><div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">girafy</span><span class="op">(</span><span class="va">gg</span><span class="op">)</span></span></code></pre></div>
</details>
</div>
<p>Et voilà !</p>
</section><section class="level2"><h2 id="des-usages-plus-avancés">Des usages plus avancés<a class="anchor" aria-label="anchor" href="#des-usages-plus-avanc%C3%A9s"></a>
</h2>
<section class="level3"><h3 id="composition-de-graphiques-patchwork">Composition de graphiques : <code>patchwork</code>
<a class="anchor" aria-label="anchor" href="#composition-de-graphiques-patchwork"></a>
</h3>
<p>Pour empiler des graphiques on peut utiliser <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> – c’est mieux que les autres solutions comme <a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a>. La syntaxe est très simple, pour empiler l’un sur l’autre le graphique <code>g1</code> et <code>g2</code> il suffit d’écrire <code>g &lt;- g1/g2</code> et l’un à côté de l’autre <code>g &lt;- g1 + g2</code>. L’objet <code>g</code> ressemble beaucoup à un graphique ggplot, mais pas complètement. Il peut cependant être utilisé dans <code>{giraph}</code> comme un ggplot. L’interactivité est alors synchrone pour tous les graphiques du <code>patchwork</code>.</p>
<p>Parfois on peut préférer <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> à un <code>facet</code>, parce que <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> autorise le mélange de graphique très différents (des line sur un panel, des bar sur un autre).</p>
<p><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> réunit les légendes communes, et les notes communes, aligne les axes et permet de faire des décorations communes. La syntaxe pour ces opérations avancées est sur l’aide de <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a> avec quelques exemples dans le cahier de graphiques.</p>
</section><section class="level3"><h3 id="aligner-des-graphiques-dans-des-chunks-différents">Aligner des graphiques dans des chunks différents<a class="anchor" aria-label="anchor" href="#aligner-des-graphiques-dans-des-chunks-diff%C3%A9rents"></a>
</h3>
<p>On peut aligner les axes de graphiques dans des chunks différents avec <a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a>. C’est assez simple et il y a un exemple sur les graphiques “immobiliers” du cahier de graphiques. On définit un graphique de référence et on en prend les “mesures” avec <code>dim &lt;- get_dim(g0)</code>. Les graphiques que l’on veut aligner seront produits par <code>set_dim(g1, dim)</code>. Le graphique de référence doit être celui dont les labels de l’axe des y sont les plus larges, ce qui peut demander un peu d’organisation dans l’écriture des chunks – rien de bien compliqué. Ceci permet de produire des pages plus soignées.</p>
</section><section class="level3"><h3 id="récupérer-les-métadonnées-de-source_data">Récupérer les métadonnées de <code>source_data()</code>
<a class="anchor" aria-label="anchor" href="#r%C3%A9cup%C3%A9rer-les-m%C3%A9tadonn%C3%A9es-de-source_data"></a>
</h3>
<p>En utilisant l’option <code>metadata=TRUE</code> dans <code>source_data()</code> on peut récupérer des informations sur, par exemple, la date de téléchargement. C’est illustré sur quelques graphiques du cahier de graphique.</p>
<p>En code cela donne le chunk ci dessous. Les données sont accessibles par <code>$data</code> et la date de téléchargement par <code>$date</code>. Cela permet de construire la note (noter que <code><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue::glue()</a></code> est appliqué aux textes passés à <code><a href="../reference/ofce_caption.html">ofce_caption()</a></code>).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">transactions</span> <span class="op">&lt;-</span> <span class="fu">source_data</span><span class="op">(</span><span class="st">"immo/data_transaction.r"</span>, metadata<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trsc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">date</span>, y<span class="op">=</span><span class="va">t</span><span class="op">*</span><span class="fl">1000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="va">bluish</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://davidgohel.github.io/ggiraph/reference/geom_point_interactive.html" class="external-link">geom_point_interactive</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>tooltip <span class="op">=</span> <span class="va">tooltip</span>, data_id <span class="op">=</span> <span class="va">date</span><span class="op">)</span>,</span>
<span>                         shape <span class="op">=</span> <span class="fl">21</span>, size <span class="op">=</span> <span class="fl">1</span>, stroke <span class="op">=</span> <span class="fl">0.2</span>, col <span class="op">=</span> <span class="st">"white"</span>,</span>
<span>                         fill <span class="op">=</span> <span class="va">bluish</span>,</span>
<span>                         hover_nearest <span class="op">=</span> <span class="cn">TRUE</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/theme_ofce.html">theme_ofce</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_log10</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/comma.html" class="external-link">number_format</a></span><span class="op">(</span>scale <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span>, suffix<span class="op">=</span><span class="st">"k"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">scalex</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/ofce_caption.html">ofce_caption</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="st">"IGEDD d'après DGFiP (MEDOC) et bases notariale"</span>,</span>
<span>    dpt <span class="op">=</span> <span class="va">transactions</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">date</span>,</span>
<span>    note <span class="op">=</span> <span class="st">"Transactions cumulées sur 12 mois, dans l'ancien, maisons et appartements, échelle log, données téléchargées le {date_jour(transactions$date)}"</span>,</span>
<span>    sub<span class="op">=</span> <span class="st">"Nombre de transactions"</span><span class="op">)</span></span></code></pre></div>
</section><section class="level3"><h3 id="la-taille-dun-graphique">La taille d’un graphique<a class="anchor" aria-label="anchor" href="#la-taille-dun-graphique"></a>
</h3>
<p>Pour définir la taille d’un graphique, on ne spécifie <strong>jamais</strong> la largeur ou la hauteur du graphique<a class="footnote-ref" role="doc-noteref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Donc jamais de &lt;code&gt;fig-width: 5&lt;/code&gt; par exemple.&lt;/p&gt;"><sup>2</sup></a> . Celle-ci est définie en fonction du support d’affichage et donc n’est pas connue à l’avance. En la fixant dans le .qmd on empêche la mise à l’échelle conditionnelle au support de sortie et cela produit des résultats embettant.</p>
<p>On utilise donc le ratio hauteur/largeur qui s’appelle <code>asp</code> (pour <em>aspect ratio</em>). Il est fixé à 0.61 (l’inverse du nombre d’or) par défaut. Lorsqu’on a une note de graphique très longue, on peut l’augmenter (malheureusement l’asp inclue le graphique et le texte des notes), à 0.7 ou 0.8.</p>
<p>Si on empile deux graphiques (un <code>facet</code> par exemple), un <code>asp</code> de 1 est possible. C’est également un bon ratio pour les cartes (1 donne un format carré).</p>
<p>Pour un graphique pleine page A4, l’<code>asp</code> est celui d’une page A4 soit 1.41. Au delà de cet <code>asp</code>, cela n’a pas beaucoup de sens et en tout cas cela posera des problèmes à l’impression sur papier.</p>
<p>Pour un graphique destiné à une présentation, le ratio doit être celui de l’écran de projection soit 9/16=0,56, ce qui n’est pas très loin de la valeur par défaut (coincidence ? je ne crois pas)</p>
<p>Le code le plus simple pour définir l’<code>asp</code> est celui-là (pour une étrange raison, il faut mettre le 0 et bine sûr utiliser le point pour les décimales, pas d’opérations possibles comme 9/16) :</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#| label: fig-fig1</span></span>
<span><span class="co">#| fig-cap: Le titre de la figure</span></span>
<span><span class="co">#| fig-asp: 0.7</span></span>
<span><span class="va">...</span></span>
<span><span class="co"># le code du graphique</span></span>
<span><span class="va">...</span></span></code></pre></div>
</section></section><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'light-border',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config);
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul Malliet, Anissa Saumtally, Xavier Timbeau.</p>
</div>

<div class="pkgdown-footer-right">
  <p>RTFM CC BY 4.0 Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
