---
title: "Recommandations pour les graphiques OFCE"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Recommandations pour les graphiques OFCE}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
library(ofce)
```

Dans cette (longue) vignette, les recommandations pour les graphiques sont d√©taill√©es.

On commence par des √©l√©ments g√©n√©raux (les 3 m√©thodes), puis des recommandations (une charte graphique) pour les dif√©rents types de graphiques (s√©ries temporelles, cat√©gories, etc) qui sont les plus fr√©quents.

## Les trois m√©thodes

Pour les graphiques on dispose de plusieurs options : `{ggplot2}`, copier-coller, fichier image.

### ggplot2

La fa√ßon pr√©f√©r√©e de faire un graphique est `{ggplot2}`. Elle est la plus flexible, permet d'avoir une source unique, peut √™tre facilement modifi√©e (uniformisation, traduction, correction, raffinements) et s'int√®gre parfaitement en html et en pdf.

Avec un faible co√ªt on peut rendre le graphique interactif (avec `{plotly}` ou `{ggiraph}`).

Un graphique `ggplot` doit contenir une couche (layer) `theme_ofce()` et limiter au maximum les d√©finitions de taille (par exemple de police de caract√®re). Ces d√©finitions doivent √™tre faites de fa√ßon globale pour assurer l'homog√©n√©it√©. **Il est important de ne pas d√©finir la taille de la figure, √ßa risque de produire des images avec des caract√®res trop petits**.

Pour changer les dimensions d'un graphique, il faut utiliser[^1] `#| fig-asp : x` ou `x` est le ratio entre la hauteur et la longueur. 0.61 est la valeur par d√©faut et correspond au nombre d'or soit entre 16/9 et 16/10. Pour des graphiques particuliers (par exemple deux graphiques empil√©s ou une carte) on peut mettre 1 (format carr√©) ou 1.4 quand on veut prendre toute la page A4.

[^1]: donc on n'utilise pas `#| fig-width` ou `fig-height`.

Le code d'un graphique `{ggplot2}` :

``` r
#| label: fig-tauxapp
#| fig-cap: Taux de taxation apparent sur le patrimoine des m√©nages
#| fig-asp: 0.61
# pas besoin d'en mettre plus, echo, message, warning sont d√©j√† d√©finis
# les donn√©es sont dans excel -- elles pourraient venir de R ou d'ailleurs
data <- readxl::read_xlsx("analyses/Tables/patrimoine menages.v2.xlsx", sheet = "tapp") 

names(data) <- c("date", "vn", "pib")
data <- data |> mutate(date = lubridate::ym(str_c(date, "-01"))) |> 
  pivot_longer(cols  = c(vn, pib)) |> 
  mutate(name = factor(name, c("vn", "pib"),
                       c("En % de la valeur nette", "En % du PIB")))
                       
# un ggplot et ses diff√©rentes couches
ggplot(data) + 
  aes(x = date, y = value, group = name, col = name, fill = name) +
  geom_line(linewidth = 1) +
  geom_point(shape = 21, col = "white", size = 2) +
  # important utiliser le theme_ofce pour uniformiser l'aspect des graphiques
  theme_ofce(legend.position = "bottom") +
  # scale date est important lorsqu'on pr√©sente des donn√©es temporelles
  # il faut penser √† convertir les dates en dates (as.Date() ou lubridate::ymd() et consorts)
  # c'est important m√™me si les dates ne sont que des ann√©es
  # ca permet aussi de m√©langer facilement des fr√©quences diff√©rentes
  scale_x_date(date_breaks = "2 years", date_labels = "%Y", 
               date_minor_breaks = "year") +
  # le choix des couleurs est tjrs d√©licat, Paul Malliet est un ma√Ætre en la mati√®re
  # uniformiser ses choix de couleurs le long d'un document c'est bien
  # donner une signification √† ses couleurs c'est mieux
  # quand en plus c'est harmonieux, c'est PM (plus que mieux ou Paul Malliet)
  PrettyCols::scale_color_pretty_d(name = NULL, palette = "Summer") +
  PrettyCols::scale_fill_pretty_d(name = NULL, palette = "Summer") +
  ylab("%") + xlab(NULL) +
  # les sources -- notez qu'on ne met pas de titre au graphique 
  # (voir la section r√©f√©rences crois√©es)
  labs(caption =
         "La fiscalit√© sur le patrimoine est compos√©e ici de la taxe fonci√®re pay√©e par les m√©nages, <br>
       des droits d'enregistrement sur les transactions immobili√®res, des droits de mutation sur les successions et les donations et de l'Imp√¥t sur la Fortune Immobili√®re (ex-ISF)<br>
       *Sources* : Insee, calculs OFCE")
```

### Copier-coller

On peut copier coller un graphique (de word, d'excel, d'ailleurs) dans le mode visuel de RStudio. √áa marche mais c'est pas le mieux. Quand on copie colle, on fait quelque chose qui ressemble √† l'option qui suit.

### Image au format png/jpeg/jpg/svg

On peut enregistrer une image (au format que l'on veut, `quarto` accepte pas mal d'options, dont les plus courantes) et l'ins√©rer dans le texte. Il y a deux fa√ßon de faire soit en `markdown` (dans le qmd, comme un lien ou autre chose), soit en utilisant `include_graphics`. L'int√©r√™t par rapport au copier-coller est que si on change le fichier qui contient l'image, √† chaque *render* du document, la bonne (la derni√®re version) image sera utilis√©e. Si on utilise des images venant de `eviews` üíÄ ou `stata` üòµ, c'est la meilleure m√©thode.

``` md
[Titre de la figure](rep/fig.png)
```

Le **r√©pertoire est toujours relatif**.

*Jamais de chemin absolu* comme "`c:/user/machin/montravail/monrepo/monimage.png`" parce que √ßa ne marchera pas sur un autre ordinateur et en plus `github` ne copiera pas l'image) et par celui qui contient le `.qmd`. Il est toujours possible de mettre les images dans un sous dossier.

Plus c'est simple et clair, mieux c'est (i.e. gardez les noms courts, explicites, pas de majuscules, bien rang√©s, conservateurs dans l'utilisation des caract√®res (**pas d'accents, pas de blancs, pas de symboles sp√©ciaux**). Donc `donnees/img.png` ou `donnees/graphique 1a5.png` ne sont pas des bons noms. Mais `figures/revenu.png` ou `figures/pib_par_tete.png` sont mieux.

``` r
#| label fig-pib2008_2024
#| fig-cap: PIB entre 2008 et 2024

knitr::include_graphics("pib2008_2024.png")
```

Notez la coh√©rence des id, nom et titre.

## Les types de graphiques

### S√©ries temporelles

#### donn√©es

Pour les s√©ries temporelles, il y a deux recommandations pour les donn√©es :

1.  utilisez le format long pour le graphique. Il peut √™tre plus simple pour calculer des taux de croissance ou des ratios de passer en format large, mais c'est mieux de passer en format long pour la partie graphique, avec une ou plusieurs colonnes pour diff√©rencier les lignes. Cela permettra d'associer une couleur √† chaque s√©rie et une facette √† chque pays par exemple.

2.  le champ d√©crivant les dates doit √™tre en type `date`. ce n'est pas toujours √©vident quand les s√©ries sont √† fr√©quence annuelle, mais c'est tr√®s utile pour m√©langer des s√©ries de fr√©quence irr√©guli√®re, pour homog√©n√©iser l'aspect des axes de dates ert mieux ma√Ætriser le formatage des dates. Pour convertir une date en date, soit elle est au format charactere et de type "2022-12-01" et la fonction `base::as.Date()` fonctionne tr√®s bien. Sinon, pur les autres cas, le package `{lubridate}` (formation R niv. 1) est tr√®s pratique et dispose de plein de fonctions permettant d'absorber beaucoup de cas (les fonctions sont par exemple `lubridate::ymd` `lubridate::dmy` `lubridate::my` etc...).

```{r}
dates <- c(2023, 2024, 2025)
as.Date(as.character(dates), format  = "%Y")
dates <- c("1/2023", "2/2024", "3/2025")
lubridate::my(dates)
```

Prenons l'exemple du graphiques sur les spreads (legislatives2024, Blot Gerrolf Plane). Les donn√©es sont √©g√©nr√©es par un scrapping sur investing.com (en attendant une solution API sur une banque de donn√©es bien faite). Les donn√©es se pr√©sentent sous la forme.

```{r}
load("data/spreads.rds")
spreads
```

Le fichier est au format long (avec deux modalit√©s pour `pays`), les dates sont au format `<date>`, donc tout va presque bien. La colonne `pays` est un peu brute. On la transforme pour avoir un label plus propre et en facteur, pour contr√¥ler l'ordre (on met France en premier, Italie en second). Il y a plusieurs m√©thodes pour arriver √† ce r√©sultat. Ici, on reste tr√®s simple parce qu'il n'y a que deux modalit√©s. Si il y en avait plus de deux (et surtout un grand nombre, possiblement √©volutif), on aurait fait quelques manipulations de cha√Ænes et on aurait utilis√© le package `{countrycode}` pour transformer les code pays en texte lisible, possiblement traduit dans diff√©rentes langues.

```{r}
library(tidyverse, quietly = TRUE)
spreads <- spreads |> 
  mutate(pays = factor( pays, c("spreadfra", "spreadita"), c("France", "Italie")))
spreads
```

#### la base

Le graphique de base est alors simple √† contruire. On utilise une couche `geom_line` et `geom_point`, une couche `aes` avec comme `x` les dates, `y` les taux et couleurs les pays. Pour `geom_line`, il faut pr√©ciser le groupe (cela peut para√Ætre redondant, mais cela peut servir si on veut colorer en fonction d'une autre variable).

```{r}
library(ofce)
cc <- PrettyCols::prettycols("Summer", n=2)
date_maj <- "2024-07-01"
main <- ggplot(spreads) +
  aes(x=date, y=taux, color=pays, group=pays) +
  geom_line(linewidth = 0.75, alpha = 0.5) +
  geom_point(stroke = 0.1, size = 0.75)+
  scale_color_manual(name = NULL, values = cc) +
  labs(
    y="Ecart de taux √† 10 ans en %",
    x=NULL,
    caption="Source: investing.com") +
  theme_ofce()+
  guides(x = guide_axis(minor.ticks = TRUE),
         y = guide_axis(minor.ticks = TRUE)) +
  theme(legend.position = "none")+
  labs(colour=NULL,
       caption = glue::glue("*Source*¬†: investing.com<br>Mis √† jour¬†: {date_maj}")) + 
  scale_x_date(labels = scales::label_date_short(format = c("%Y")),
               date_breaks = "5 years")
main
```

On utilise la palette `summer` de `{PrettyCols}` (affaire de go√ªt). On utilise la fonction `theme_ofce()` pour homog√©n√©iser la pr√©sentation des graphiques. On pr√©cise les labels des axes inutile pour `x`, explicite pour `y`. Et la source, en notant que l'on peut utiliser `markdown` dans le texte de la source, ce qui permet de mettre *Source* en italique.

Le recours √† `scale_x_date` permet de sp√©cifier facilement le format des dates (avec la syntaxe de `base::strptime()`) et la fonction `scale::label_date_short()` permet un formatage √©l√©gant des dates (voir plus bas la partie insert).

On ajoute au graphique des annotations. C'est ici faid de fa√ßon laborieuse, on peut construire des fonctions (formation R niv. 2) ou utiliser `{esquisse}` ou `{gganotate}` mais ces deux solutions ont des d√©fauts.

#### les annotations

```{r}
annotations <-  list(
  annotate(
    "text", x = as.Date("2013-12-01"), y= 1, 
    label="France" , color=cc[[1]] , size=3, fontface ="bold"),
  annotate(
    "text", x = as.Date("2010-06-01"), y= 3 ,
    label="Italie" , color=cc[[2]], size=3, fontface ="bold"),
  annotate(
    "text", 
    x = as.Date("2009-12-01"), 
    y= 5 , 
    label="Crise des dettes souveraines\n26 juillet 2012 : Mario Draghi \n 'Whatever it takes'" ,
    color= "grey33", 
    size=2,
    hjust=1),
  annotate(
    "segment", 
    x = as.Date("2010-03-01"), 
    xend = as.Date("2011-07-01"), 
    y = 5, 
    yend = 4.6, 
    colour = "grey33",
    linewidth=0.25,
    arrow= arrow(length = unit(4, "point"))),
  annotate(
    "text",
    x = as.Date("2017-9-01"),
    y= 4.5 ,
    size = 2,
    label="4 mars 2018 : √âlections italiennes\n1er juin : gouvernement de coalition" ,
    color= "grey33"),
  annotate(
    "segment",
    x = as.Date("2017-09-01"), 
    xend = as.Date("2018-05-01"), 
    y = 4.2,
    yend = 3,
    colour = "grey33", 
    linewidth=0.25, 
    arrow=arrow(length = unit(4, "point"))),
  annotate(
    "text",
    x = as.Date("2022-01-01"), 
    hjust = 1, 
    y= 0.8, 
    label="Annonce de la dissolution" , 
    color= "grey33",
    size=2),
  annotate(
    "segment",
    x = as.Date("2022-03-01"), 
    xend = as.Date("2024-04-01"), 
    y = 0.8, 
    yend = 0.7, 
    colour = "grey33",
    linewidth=0.25,
    arrow= arrow(length = unit(4, "point"))))

main + annotations
```

Le r√©sultat est int√©ressant, mais le graphique a cependant un d√©faut, il y a trop de points, ce qui est du √† la fr√©quence quotidienne et donc il perd en clart√©. On va donc faire deux choses : r√©duire la fr√©quence en agr√©geant les donn√©es par mois, puis on va ajouter un insert.

#### fr√©quence mensuelle et insert

Pour construire les donn√©es √† la fr√©quence mensuelle, on va cr√©er un champ de date, mais retenant une seule date par mois (au milieu du mois).

```{r}
dates <- spreads$date
lubridate::day(dates) <- 15
spreads_m <- spreads |> 
  mutate( date = dates) |> 
  group_by(date, pays) |> 
  summarize(taux_max = max(taux, na.rm=TRUE),
            taux_min = min(taux, na.rm=TRUE),
            taux = mean(taux, na.rm=TRUE))
spreads_m
```

On peut alors facilement modifier le graphique `main` en utilisant `%+%` (cette instruction modifie les donn√©es en entr√©e du graphique par le nouveau jeu de donn√©es qu'on vient de construire qui a exactement la m√™me structure, comme on a utilis√© les dates le passage du quotidien au mensuel se fait automatiquement, les axes sont parfaitement construits) :

```{r}
main %+% spreads_m
```

L'insert est le m√™me graphique, en enlevant les annotations, en simplifiant les axes et en zoomant sur les deux derniers mois.

```{r}
inset <- ggplot(spreads) +
  aes(x=date, y=taux, color=pays, group=pays) +
  geom_vline(xintercept = as.Date("2024-06-09"),
             linewidth = 0.1,
             color = "grey50") +
  geom_line( linewidth = 0.25, alpha=0.75) +
  geom_point(stroke = 0.1, size = .75)+
  guides(color = "none") +
  scale_color_manual(name = NULL, values = cc) +
  theme_ofce(base_size = 7,
             axis.line.x = element_blank(),
             axis.line.y = element_blank(),
             plot.background = element_rect(fill = "white")) + 
  scale_x_date(labels = scales::label_date_short(format = c("%Y", "%B")),
               date_breaks = "1 month",
               limits = c(Sys.Date()-months(2), NA)) +
  ylim(c(0, 2)) + xlab(NULL) +ylab(NULL) 
inset
```

On l'ins√®re dans le graphique principal en utilisant `{patchwork}`, ce qui donne le graphique, plus lisible et plus √©l√©gant.

```{r}
library(patchwork)
main <- (main + annotations) %+% spreads_m
main  + inset_element(inset, 0.75, 0.5, 1, 1)
```

#### Interactif

La derni√®re √©tape est l'interctaivit√©. On utilise le package `{ggiraph}` qui va permettre d'int√©grer des tooltips tr√®s simplement et tr√®s efficacement. On peut aussi avec des s√©lections dyanamiques ou encore des zooms.

#### double √©chelle

Non mais ca va pas ?

### Graphique XY

#### interactif

### Graphiques en colonnes empil√©es

#### interactif

#### alternatives

##### wafle

##### treemap

### Lollypop

#### interactif

### Boites √† moustache

#### interactif

### Cartes
